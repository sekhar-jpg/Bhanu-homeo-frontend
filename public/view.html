<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bhanu Homeopathy - Case Form</title>
</head>
<body>
  <h1>Case Form</h1>
  <form id="caseForm">
    <label>Name: <input type="text" id="name" required /></label><br>
    <label>Phone: <input type="text" id="phone" required /></label><br>
    <label>Date of Visit: <input type="date" id="dateOfVisit" required /></label><br>
    <label>Follow-Up Date: <input type="date" id="followUpDate" required /></label><br>
    <label>Chief Complaints: <textarea id="chiefComplaints"></textarea></label><br>
    <label>Present Illness: <textarea id="presentIllness"></textarea></label><br>
    <label>Past History: <textarea id="pastHistory"></textarea></label><br>
    <label>Family History: <textarea id="familyHistory"></textarea></label><br>
    <label>Personal History: <textarea id="personalHistory"></textarea></label><br>
    <label>Mental Symptoms: <textarea id="mentalSymptoms"></textarea></label><br>
    <label>General Remarks: <textarea id="generalRemarks"></textarea></label><br>
    <label>Observations: <textarea id="observations"></textarea></label><br>

    <h3>Prescription</h3>
    <table id="prescriptionTable">
      <tr>
        <th>Date</th>
        <th>Remedy</th>
        <th>Potency</th>
        <th>Dose</th>
        <th>Instructions</th>
      </tr>
      <tr>
        <td><input type="date" name="prescriptionDate" /></td>
        <td><input type="text" name="remedy" /></td>
        <td><input type="text" name="potency" /></td>
        <td><input type="text" name="dose" /></td>
        <td><input type="text" name="instructions" /></td>
      </tr>
    </table>
    <button type="button" onclick="addPrescriptionRow()">Add Prescription</button><br><br>

    <button type="submit">Submit</button>
  </form>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const caseId = urlParams.get('id');

    // Load case if editing
    if (caseId) {
      fetch(`https://backend-bhanu-app.onrender.com/api/cases/${caseId}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('name').value = data.name;
          document.getElementById('phone').value = data.phone;
          document.getElementById('dateOfVisit').value = data.dateOfVisit.split('T')[0];
          document.getElementById('followUpDate').value = data.followUpDate.split('T')[0];
          document.getElementById('chiefComplaints').value = data.chiefComplaints || '';
          document.getElementById('presentIllness').value = data.presentIllness || '';
          document.getElementById('pastHistory').value = data.pastHistory || '';
          document.getElementById('familyHistory').value = data.familyHistory || '';
          document.getElementById('personalHistory').value = data.personalHistory || '';
          document.getElementById('mentalSymptoms').value = data.mentalSymptoms || '';
          document.getElementById('generalRemarks').value = data.generalRemarks || '';
          document.getElementById('observations').value = data.observations || '';

          const table = document.getElementById('prescriptionTable');
          table.innerHTML = `
            <tr>
              <th>Date</th>
              <th>Remedy</th>
              <th>Potency</th>
              <th>Dose</th>
              <th>Instructions</th>
            </tr>
          `;
          data.prescription.forEach(p => {
            const row = `<tr>
              <td><input type="date" name="prescriptionDate" value="${p.date.split('T')[0]}" /></td>
              <td><input type="text" name="remedy" value="${p.remedy}" /></td>
              <td><input type="text" name="potency" value="${p.potency}" /></td>
              <td><input type="text" name="dose" value="${p.dose}" /></td>
              <td><input type="text" name="instructions" value="${p.instructions}" /></td>
            </tr>`;
            table.innerHTML += row;
          });
        });
    }

    function addPrescriptionRow() {
      const row = `<tr>
        <td><input type="date" name="prescriptionDate" /></td>
        <td><input type="text" name="remedy" /></td>
        <td><input type="text" name="potency" /></td>
        <td><input type="text" name="dose" /></td>
        <td><input type="text" name="instructions" /></td>
      </tr>`;
      document.getElementById('prescriptionTable').innerHTML += row;
    }

    document.getElementById('caseForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const getInput = id => document.getElementById(id).value;

      const formData = {
        name: getInput('name'),
        phone: getInput('phone'),
        dateOfVisit: getInput('dateOfVisit'),
        followUpDate: getInput('followUpDate'),
        chiefComplaints: getInput('chiefComplaints'),
        presentIllness: getInput('presentIllness'),
        pastHistory: getInput('pastHistory'),
        familyHistory: getInput('familyHistory'),
        personalHistory: getInput('personalHistory'),
        mentalSymptoms: getInput('mentalSymptoms'),
        generalRemarks: getInput('generalRemarks'),
        observations: getInput('observations'),
        prescription: []
      };

      const rows = document.querySelectorAll('#prescriptionTable tr');
      rows.forEach((row, i) => {
        if (i === 0) return; // skip header
        const inputs = row.querySelectorAll('input');
        if (inputs[0].value) {
          formData.prescription.push({
            date: inputs[0].value,
            remedy: inputs[1].value,
            potency: inputs[2].value,
            dose: inputs[3].value,
            instructions: inputs[4].value
          });
        }
      });

      const method = caseId ? 'PUT' : 'POST';
      const url = caseId
        ? `https://backend-bhanu-app.onrender.com/api/cases/${caseId}`
        : `https://backend-bhanu-app.onrender.com/api/cases`;

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      if (res.ok) {
        alert("Case saved successfully!");
        window.location.href = "follow-ups.html"; // Redirect back to list
      } else {
        alert("Failed to save case.");
      }
    });
  </script>
</body>
</html>
